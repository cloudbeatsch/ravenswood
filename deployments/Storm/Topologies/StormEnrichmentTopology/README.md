
# Read and enrich messages from Event Hubs using Apache Storm

## Prerequisites

* [Apache Storm 1.2.2](http://storm.apache.org/releases/1.2.2/index.html)

* [Azure Event Hub](https://docs.microsoft.com/azure/event-hubs/event-hubs-create)

* [JDK version 10](http://www.oracle.com/technetwork/java/javase/downloads/index.html)

* [Maven](https://maven.apache.org/download.cgi): Maven is a project build system for Java projects.

* Container Hosting such as [Azure Container Instances](https://azure.microsoft.com/en-gb/services/container-instances/) or [Azure Kubernetes Service](https://docs.microsoft.com/en-us/azure/container-service/kubernetes/container-service-kubernetes-walkthrough)


## How it works

The `resources/writer.yaml` topology writes random data to an event hub. The data is generated by the `UserMessageSpout` component, and is a message ID and user ID.

The `resources/reader.yaml` topology reads data from Event Hub (the data written by EventHubWriter,) parses the JSON data. It also emits the values read from Event Hub to Storm logs.

The `resources/enricher.yaml` topology is the similar to the `reader.yaml` topology, but it also calls two web services which enriches the message as it passes through the topology. 

The data format in Event Hub is a JSON document with the following format:

    { 
        "messageDate": string, 
        "messageId": string, 
        "userId": integer, 
        "value": integer 
    }

The parser component adds a timestamp value when it processes JSON data read from Event Hub. The enricher components calls the web services which return a JSON object whose elements are appended to the existing `body` field of the message.

### Enrichment Web Services

The enrichment components of the topology are designed to do a `GET` request to a Web Service, passing in the userId as a query parameter. The expected response will have `Content-Type: application/json` header set and in the following format:

    { "key": "value" }

#### Example

Original message: 

    { ... , "userId": 50 }

After first enrichment:

    { ... , "userId": 50, "body": { "name": "Sam" } }

After second enrichment:

    { ... , "userId": 50, "body": { "name": "Sam", "city": "Melbourne" } }

and so on.

## Required information

* An Azure event hub with two shared access policies:
    * The **writer** policy must have **write** permission to the event hub.
    * The **reader** policy must have **listen** permissions to the event hub.

* To connect to the event hub from Storm, you need the following information:
    * The connection string for the **writer** policy.
    * The policy key for the __reader__ policy.
    * The name of your Event Hub.
    * The namespace that your Event Hub was created in.
    * The number of partitions available with your Event Hub configuration.
* Enrichment Web Service URLs
## Confgure, build and run

 You need to have [Storm development environment](http://storm.apache.org/releases/current/Setting-up-development-environment.html) setup.
### Using dev.properties

1. Add the Event Hub configuration to the `dev.properties` file. This is used to configure the spout that reads from Event Hub and the bolt that writes to it. 

2. Run `./script/run.local.sh`

### Using ENV variables

1. Open `./script/run.local-env.sh`. Edit the environment variables that are being set.

2. Run `./script/run.local-env.sh`.

#
LACE TODO: ADD WEBSERVICES